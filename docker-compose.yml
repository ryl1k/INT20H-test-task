name: int20h-test-task

services:
  postgres:
    image: postgres:16.1
    container_name: int20h-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-int20h}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/migrations/dev/20260223192949_orders.up.sql:/docker-entrypoint-initdb.d/001_orders.up.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user} -d ${POSTGRES_DB:-int20h}"]
      interval: 5s
      timeout: 5s
      retries: 12

  server:
    container_name: int20h-server
    build:
      context: ./server
      dockerfile: Dockerfile.heroku
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      HTTP_SERVER_PORT: "8080"
      POSTGRES_CONNECTION_URI: ${POSTGRES_CONNECTION_URI:-postgres://user:password@postgres:5432/int20h?sslmode=disable&timezone=UTC}
      POSTGRES_MAX_CONNS: ${POSTGRES_MAX_CONNS:-20}
      POSTGRES_MIN_CONNS: ${POSTGRES_MIN_CONNS:-5}
      POSTGRES_MAX_CONN_LIFETIME: ${POSTGRES_MAX_CONN_LIFETIME:-1h}
      POSTGRES_MAX_CONN_IDLE_TIME: ${POSTGRES_MAX_CONN_IDLE_TIME:-30m}
      BATCH_ORDER_PROCESSING_TIMEOUT: ${BATCH_ORDER_PROCESSING_TIMEOUT:-1h}
      ORDERS_BATCH_SIZE: ${ORDERS_BATCH_SIZE:-2000}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-5242880}
      API_KEY: ${API_KEY:-hackathon-dev-key}
    ports:
      - "${SERVER_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8080/v1/health > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  client:
    container_name: int20h-client
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8080/v1}
        VITE_API_KEY: ${VITE_API_KEY:-hackathon-dev-key}
    restart: unless-stopped
    depends_on:
      server:
        condition: service_healthy
    ports:
      - "${CLIENT_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000 > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  postgres_data:
